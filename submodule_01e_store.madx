print, text="";
print, text="";
print, text="  --- Submodule 1e: store";
print, text="  ----------------------";
print, text="";
print, text="";



!+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++;
!                        STORE the optics
!+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++;

exec, crossing_disable;

if (par_verbose==1){
  if (mylhcbeam<3){
    use, sequence=lhcb1;
    select, flag=twiss,clear;
    select, flag=twiss, pattern="IP1", column=name,s,betx,bety,alfx,alfy,dx,dpx,mux,muy;
    select, flag=twiss, pattern="IP2", column=name,s,betx,bety,alfx,alfy,dx,dpx,mux,muy;
    select, flag=twiss, pattern="IP5", column=name,s,betx,bety,alfx,alfy,dx,dpx,mux,muy;
    select, flag=twiss, pattern="IP8", column=name,s,betx,bety,alfx,alfy,dx,dpx,mux,muy;
    twiss, sequence=lhcb1, file=twiss_crossing_disable.b1;
    twiss, sequence=lhcb1, table=twisscrossingdisableb1; ! handle for further analysis
    system, "cat twiss_crossing_disable.b1";
  };

  use, sequence=lhcb2;
  select, flag=twiss,clear;
  select, flag=twiss, pattern="IP1", column=name,s,betx,bety,alfx,alfy,dx,dpx,mux,muy;
  select, flag=twiss, pattern="IP2", column=name,s,betx,bety,alfx,alfy,dx,dpx,mux,muy;
  select, flag=twiss, pattern="IP5", column=name,s,betx,bety,alfx,alfy,dx,dpx,mux,muy;
  select, flag=twiss, pattern="IP8", column=name,s,betx,bety,alfx,alfy,dx,dpx,mux,muy;
  twiss, sequence=lhcb2, file=twiss_crossing_disable.b2;
  twiss, sequence=lhcb2, table=twisscrossingdisableb2; ! handle for further analysis
  system, "cat twiss_crossing_disable.b2";
};

! Switch on the crossing scheme
exec, crossing_restore;

if (par_verbose==1){
  if (mylhcbeam<3){
    use, sequence=lhcb1;
    select,flag=twiss,clear;
    select, flag=twiss, pattern="IP1", column=name,s,x,y,px,py;
    select, flag=twiss, pattern="IP2", column=name,s,x,y,px,py;
    select, flag=twiss, pattern="IP5", column=name,s,x,y,px,py;
    select, flag=twiss, pattern="IP8", column=name,s,x,y,px,py;
    twiss, sequence=lhcb1, file=twiss_crossing_enable.b1;
    twiss, sequence=lhcb1, table=twisscrossingenableb1; ! handle for further analysis
    system, "cat twiss_crossing_enable.b1";
  };

  use, sequence=lhcb2;
  select, flag=twiss,clear;
  select, flag=twiss, pattern="IP1", column=name,s,x,y,px,py;
  select, flag=twiss, pattern="IP2", column=name,s,x,y,px,py;
  select, flag=twiss, pattern="IP5", column=name,s,x,y,px,py;
  select, flag=twiss, pattern="IP8", column=name,s,x,y,px,py;
  twiss, sequence=lhcb2, file=twiss_crossing_enable.b2;
  twiss, sequence=lhcb2, table=twisscrossingenableb2;  ! handle for further analysis
  system, "cat twiss_crossing_enable.b2";
};

on_disp=0; !more precise angles at IPs

!Record the nominal IP position and crossing angle
if(mylhcbeam==1) {use,  sequence=lhcb1;};
if(mylhcbeam>1) {use,  sequence=lhcb2;};
twiss;
xnom1=table(twiss,IP1,x);pxnom1=table(twiss,IP1,px);ynom1=table(twiss,IP1,y);pynom1=table(twiss,IP1,py);
xnom2=table(twiss,IP2,x);pxnom2=table(twiss,IP2,px);ynom2=table(twiss,IP2,y);pynom2=table(twiss,IP2,py);
xnom5=table(twiss,IP5,x);pxnom5=table(twiss,IP5,px);ynom5=table(twiss,IP5,y);pynom5=table(twiss,IP5,py);
xnom8=table(twiss,IP8,x);pxnom8=table(twiss,IP8,px);ynom8=table(twiss,IP8,y);pynom8=table(twiss,IP8,py);
value,xnom1,xnom2,xnom5,xnom8;
value,ynom1,ynom2,ynom5,ynom8;
value,pxnom1,pxnom2,pxnom5,pxnom8;
value,pynom1,pynom2,pynom5,pynom8;